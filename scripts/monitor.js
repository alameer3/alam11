const cron = require('node-cron')
const { PrismaClient } = require('@prisma/client')

const prisma = new PrismaClient()

class MonitoringService {
  constructor() {
    this.isRunning = false
    this.healthChecker = null
  }

  async initializeHealthChecker() {
    // ุชููุฆุฉ ูุงุญุต ุงูุตุญุฉ (ุณูุชู ุงุณุชุจุฏุงูู ุจู ES modules ูู production)
    console.log('๐ง ุชููุฆุฉ ูุธุงู ุงููุฑุงูุจุฉ...')
    
    // ุฅุถุงูุฉ ุตูุญุงุช ุงูุชุฑุงุถูุฉ ูููุฑุงูุจุฉ
    await this.addDefaultMonitors()
  }

  async addDefaultMonitors() {
    try {
      // ุฅุถุงูุฉ ุตูุญุงุช ุงููููุน ุงูุฃุณุงุณูุฉ ูููุฑุงูุจุฉ
      const defaultPages = [
        {
          url: 'http://localhost:3000',
          name: 'ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ'
        },
        {
          url: 'http://localhost:3000/movies',
          name: 'ุตูุญุฉ ุงูุฃููุงู'
        },
        {
          url: 'http://localhost:3000/series',
          name: 'ุตูุญุฉ ุงููุณูุณูุงุช'
        },
        {
          url: 'http://localhost:3000/api/health',
          name: 'API ุงูุตุญุฉ'
        }
      ]

      for (const page of defaultPages) {
        const existing = await prisma.pageMonitor.findUnique({
          where: { url: page.url }
        })

        if (!existing) {
          await prisma.pageMonitor.create({
            data: {
              url: page.url,
              name: page.name,
              status: 'up',
              isActive: true
            }
          })
          console.log(`โ ุชูุช ุฅุถุงูุฉ ูุฑุงูุจุฉ ${page.name}`)
        }
      }

      // ุฅุถุงูุฉ ุฎูุงุฏู ุงูุชุฑุงุถูุฉ ูููุฑุงูุจุฉ
      const defaultServers = [
        {
          serverId: 'main-server',
          serverName: 'ุงูุฎุงุฏู ุงูุฑุฆูุณู',
          serverUrl: 'http://localhost:3000'
        }
      ]

      for (const server of defaultServers) {
        const existing = await prisma.serverMonitor.findUnique({
          where: { serverId: server.serverId }
        })

        if (!existing) {
          await prisma.serverMonitor.create({
            data: {
              serverId: server.serverId,
              serverName: server.serverName,
              serverUrl: server.serverUrl,
              status: 'online',
              isActive: true
            }
          })
          console.log(`โ ุชูุช ุฅุถุงูุฉ ูุฑุงูุจุฉ ${server.serverName}`)
        }
      }

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุฑุงูุจุงุช ุงูุงูุชุฑุงุถูุฉ:', error)
    }
  }

  async runHealthCheck() {
    if (this.isRunning) {
      console.log('โณ ูุญุต ุงูุตุญุฉ ุฌุงุฑู ุจุงููุนู...')
      return
    }

    this.isRunning = true

    try {
      console.log('๐ ุจุฏุก ูุญุต ุงูุตุญุฉ...')

      // ูุญุต ุตุญุฉ ุงููุธุงู ุงูุนุงูุฉ
      await this.checkSystemHealth()

      // ูุญุต ุงูุตูุญุงุช ุงููุฑุงูุจุฉ
      await this.checkMonitoredPages()

      // ูุญุต ุงูุฎูุงุฏู ุงููุฑุงูุจุฉ
      await this.checkMonitoredServers()

      // ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ
      await this.cleanupOldData()

      console.log('โ ุงูุชูู ูุญุต ุงูุตุญุฉ ุจูุฌุงุญ')

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ูุญุต ุงูุตุญุฉ:', error)
    } finally {
      this.isRunning = false
    }
  }

  async checkSystemHealth() {
    try {
      const memoryUsage = process.memoryUsage()
      const uptime = process.uptime()

      // ุญุณุงุจ ุงููุณุชุฎุฏููู ุงููุดุทูู
      const activeUsers = await prisma.session.count({
        where: {
          expires: {
            gt: new Date()
          }
        }
      })

      // ุญุณุงุจ ุฅุฌูุงูู ุงูุทูุจุงุช ุงูููู
      const today = new Date()
      today.setHours(0, 0, 0, 0)
      
      const totalRequests = await prisma.view.count({
        where: {
          viewedAt: {
            gte: today
          }
        }
      })

      // ุญุณุงุจ ูุนุฏู ุงูุฃุฎุทุงุก
      const totalErrors = await prisma.errorLog.count({
        where: {
          createdAt: {
            gte: today
          },
          level: 'error'
        }
      })

      const errorRate = totalRequests > 0 ? (totalErrors / totalRequests) * 100 : 0

      // ุชุญุฏูุฏ ุญุงูุฉ ุงููุธุงู
      let systemStatus = 'healthy'
      if (errorRate > 10 || memoryUsage.heapUsed / memoryUsage.heapTotal > 0.9) {
        systemStatus = 'critical'
      } else if (errorRate > 5 || memoryUsage.heapUsed / memoryUsage.heapTotal > 0.75) {
        systemStatus = 'warning'
      }

      // ุญูุธ ุจูุงูุงุช ุตุญุฉ ุงููุธุงู
      await prisma.systemHealth.create({
        data: {
          status: systemStatus,
          cpuUsage: 0, // ูููู ุงูุญุตูู ุนูููุง ูู systeminformation
          memoryUsage: (memoryUsage.heapUsed / memoryUsage.heapTotal) * 100,
          diskUsage: 0, // ูููู ุงูุญุตูู ุนูููุง ูู systeminformation
          responseTime: 0, // ุณูุชู ุชุญุฏูุซูุง ูู ูุญุต ุงูุตูุญุงุช
          uptime: uptime,
          activeUsers: activeUsers,
          totalRequests: totalRequests,
          errorRate: errorRate,
          checkedAt: new Date()
        }
      })

      console.log(`๐ ุตุญุฉ ุงููุธุงู: ${systemStatus}`)

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ูุญุต ุตุญุฉ ุงููุธุงู:', error)
    }
  }

  async checkMonitoredPages() {
    try {
      const pages = await prisma.pageMonitor.findMany({
        where: { isActive: true }
      })

      for (const page of pages) {
        await this.checkPageHealth(page)
      }

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ูุญุต ุงูุตูุญุงุช ุงููุฑุงูุจุฉ:', error)
    }
  }

  async checkPageHealth(page) {
    const startTime = Date.now()
    
    try {
             const controller = new AbortController()
       const timeoutId = setTimeout(() => controller.abort(), 5000)
       
       const response = await fetch(page.url, {
         signal: controller.signal
       })
       
       clearTimeout(timeoutId)
      
      const responseTime = Date.now() - startTime
      
      let status = 'up'
      if (response.status >= 500) {
        status = 'down'
      } else if (response.status >= 400 || responseTime > 3000) {
        status = 'slow'
      } else if (responseTime > 1500) {
        status = 'slow'
      }

      await prisma.pageMonitor.update({
        where: { id: page.id },
        data: {
          status: status,
          responseTime: responseTime,
          statusCode: response.status,
          errorMessage: null,
          lastChecked: new Date()
        }
      })

      console.log(`๐ ${page.name}: ${status} (${responseTime}ms)`)

    } catch (error) {
      const responseTime = Date.now() - startTime
      
      await prisma.pageMonitor.update({
        where: { id: page.id },
        data: {
          status: 'down',
          responseTime: responseTime,
          statusCode: null,
          errorMessage: error.message,
          lastChecked: new Date()
        }
      })

      console.log(`โ ${page.name}: ุฎุทุฃ - ${error.message}`)
    }
  }

  async checkMonitoredServers() {
    try {
      const servers = await prisma.serverMonitor.findMany({
        where: { isActive: true }
      })

      for (const server of servers) {
        await this.checkServerHealth(server)
      }

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ูุญุต ุงูุฎูุงุฏู ุงููุฑุงูุจุฉ:', error)
    }
  }

  async checkServerHealth(server) {
    const startTime = Date.now()
    
    try {
             const controller = new AbortController()
       const timeoutId = setTimeout(() => controller.abort(), 3000)
       
       const response = await fetch(server.serverUrl, {
         signal: controller.signal
       })
       
       clearTimeout(timeoutId)
      
      const responseTime = Date.now() - startTime
      
      let status = 'online'
      if (response.status >= 500) {
        status = 'offline'
      }

      await prisma.serverMonitor.update({
        where: { id: server.id },
        data: {
          status: status,
          responseTime: responseTime,
          lastPing: new Date()
        }
      })

      console.log(`๐ฅ๏ธ ${server.serverName}: ${status} (${responseTime}ms)`)

    } catch (error) {
      const responseTime = Date.now() - startTime
      
      const currentServer = await prisma.serverMonitor.findUnique({
        where: { id: server.id }
      })

      await prisma.serverMonitor.update({
        where: { id: server.id },
        data: {
          status: 'offline',
          responseTime: responseTime,
          errorCount: (currentServer?.errorCount || 0) + 1,
          lastPing: new Date()
        }
      })

      console.log(`โ ${server.serverName}: ุบูุฑ ูุชุตู - ${error.message}`)
    }
  }

  async cleanupOldData() {
    try {
      // ุญุฐู ุณุฌูุงุช ุตุญุฉ ุงููุธุงู ุงููุฏููุฉ (ุฃูุซุฑ ูู 7 ุฃูุงู)
      const sevenDaysAgo = new Date()
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)

      const deletedHealth = await prisma.systemHealth.deleteMany({
        where: {
          checkedAt: {
            lt: sevenDaysAgo
          }
        }
      })

      // ุญุฐู ุณุฌูุงุช ุงูุฃุฎุทุงุก ุงููุฏููุฉ (ุฃูุซุฑ ูู 30 ููู)
      const thirtyDaysAgo = new Date()
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

      const deletedLogs = await prisma.errorLog.deleteMany({
        where: {
          createdAt: {
            lt: thirtyDaysAgo
          }
        }
      })

      if (deletedHealth.count > 0 || deletedLogs.count > 0) {
        console.log(`๐งน ุชู ุญุฐู ${deletedHealth.count} ุณุฌู ุตุญุฉ ู ${deletedLogs.count} ุณุฌู ุฎุทุฃ ูุฏูู`)
      }

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ:', error)
    }
  }

  start() {
    console.log('๐ ุจุฏุก ุฎุฏูุฉ ุงููุฑุงูุจุฉ...')

    // ุชููุฆุฉ ุงููุธุงู
    this.initializeHealthChecker()

    // ูุญุต ููุฑู ุนูุฏ ุงูุจุฏุก
    setTimeout(() => {
      this.runHealthCheck()
    }, 5000)

    // ูุญุต ูู 5 ุฏูุงุฆู
    cron.schedule('*/5 * * * *', () => {
      console.log('โฐ ุชุดุบูู ูุญุต ุฏูุฑู...')
      this.runHealthCheck()
    })

    // ุชูุฑูุฑ ูููู ูู ุงูุณุงุนุฉ 9 ุตุจุงุญุงู
    cron.schedule('0 9 * * *', async () => {
      console.log('๐ง ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู...')
      try {
        // ุฅุฑุณุงู ุชูุฑูุฑ ูููู (ูุญุชุงุฌ ุชูููุฐ ุฎุฏูุฉ ุงูุฅุดุนุงุฑุงุช)
        console.log('โ ุชู ุฅุฑุณุงู ุงูุชูุฑูุฑ ุงููููู')
      } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุชูุฑูุฑ:', error)
      }
    })

    // ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ ููููุงู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
    cron.schedule('0 2 * * *', () => {
      console.log('๐งน ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ...')
      this.cleanupOldData()
    })

    console.log('โ ุชู ุชุดุบูู ุฎุฏูุฉ ุงููุฑุงูุจุฉ ุจูุฌุงุญ')
    console.log('๐ ุฌุฏููุฉ ุงูููุงู:')
    console.log('   - ูุญุต ูู 5 ุฏูุงุฆู')
    console.log('   - ุชูุฑูุฑ ูููู ุงูุณุงุนุฉ 9:00')
    console.log('   - ุชูุธูู ุงูุจูุงูุงุช ุงูุณุงุนุฉ 2:00')
  }

  async stop() {
    console.log('๐ ุฅููุงู ุฎุฏูุฉ ุงููุฑุงูุจุฉ...')
    await prisma.$disconnect()
  }
}

// ุชุดุบูู ุงูุฎุฏูุฉ
const monitoringService = new MonitoringService()

// ูุนุงูุฌุฉ ุฅุดุงุฑุงุช ุงูุฅููุงู
process.on('SIGINT', async () => {
  console.log('\n๐ ุชู ุงุณุชูุจุงู ุฅุดุงุฑุฉ ุงูุฅููุงู...')
  await monitoringService.stop()
  process.exit(0)
})

process.on('SIGTERM', async () => {
  console.log('\n๐ ุชู ุงุณุชูุจุงู ุฅุดุงุฑุฉ ุงูุฅููุงุก...')
  await monitoringService.stop()
  process.exit(0)
})

// ุจุฏุก ุงูุฎุฏูุฉ
monitoringService.start()